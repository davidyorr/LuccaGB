package main

import (
	"fmt"
	"syscall/js"
)

// program counter
var PC uint16

// 0x0000 - 0x7FFF, dynamically sized
var cartridgeRom []uint8

// 0x8000 - 9FFF
var videoRam [8192]uint8

// 0xC000 - 0xDFFF
var workingRam [8192]uint8

// 0xFE00 - 0xFE9F
var oam [160]uint8

// 0xFF00 - 0xFF7F
var ioRegisters [128]uint8

// 0xFF80 - 0xFFFE
var highRam [127]uint8

// 0xFFFF
var interruptRegister uint8

func main() {
	fmt.Println("Hello EchoGB!")

	js.Global().Set("loadRom", js.FuncOf(loadRom))

	<-make(chan struct{})
}

func initPostBootRomState() {
	ioRegisters[0xFF00-0xFF00] = 0xCF // P1
	ioRegisters[0xFF01-0xFF00] = 0x00 // SB
	ioRegisters[0xFF02-0xFF00] = 0x7E // SC
	// ioRegisters[0xFF03-0xFF00] = 0xFF // unused
	ioRegisters[0xFF04-0xFF00] = 0x18 // DIV
	ioRegisters[0xFF05-0xFF00] = 0x00 // TIMA
	ioRegisters[0xFF06-0xFF00] = 0x00 // TMA
	ioRegisters[0xFF07-0xFF00] = 0xF8 // TAC
	ioRegisters[0xFF0F-0xFF00] = 0xE1 // IF
	ioRegisters[0xFF10-0xFF00] = 0x80 // NR10
	ioRegisters[0xFF11-0xFF00] = 0xBF // NR11
	ioRegisters[0xFF12-0xFF00] = 0xF3 // NR12
	ioRegisters[0xFF13-0xFF00] = 0xFF // NR13
	ioRegisters[0xFF14-0xFF00] = 0xBF // NR14
	ioRegisters[0xFF16-0xFF00] = 0x3F // NR21
	ioRegisters[0xFF17-0xFF00] = 0x00 // NR22
	ioRegisters[0xFF18-0xFF00] = 0xFF // NR23
	ioRegisters[0xFF19-0xFF00] = 0xBF // NR24
	ioRegisters[0xFF1A-0xFF00] = 0x7F // NR30
	ioRegisters[0xFF1B-0xFF00] = 0xFF // NR31
	ioRegisters[0xFF1C-0xFF00] = 0x9F // NR32
	ioRegisters[0xFF1D-0xFF00] = 0xFF // NR33
	ioRegisters[0xFF1E-0xFF00] = 0xBF // NR34
	ioRegisters[0xFF20-0xFF00] = 0xFF // NR41
	ioRegisters[0xFF21-0xFF00] = 0x00 // NR42
	ioRegisters[0xFF22-0xFF00] = 0x00 // NR43
	ioRegisters[0xFF23-0xFF00] = 0xBF // NR44
	ioRegisters[0xFF24-0xFF00] = 0x77 // NR50
	ioRegisters[0xFF25-0xFF00] = 0xF3 // NR51
	ioRegisters[0xFF26-0xFF00] = 0xF1 // NR52
	ioRegisters[0xFF40-0xFF00] = 0x91 // LCDC
	ioRegisters[0xFF41-0xFF00] = 0x81 // STAT
	ioRegisters[0xFF42-0xFF00] = 0x00 // SCY
	ioRegisters[0xFF43-0xFF00] = 0x00 // SCX
	ioRegisters[0xFF44-0xFF00] = 0x91 // LY
	ioRegisters[0xFF45-0xFF00] = 0x00 // LYC
	ioRegisters[0xFF46-0xFF00] = 0xFF // DMA
	ioRegisters[0xFF47-0xFF00] = 0xFC // BGP
	// left uninitialized
	// ioRegisters[0xFF48-0xFF00] = 0x00 // OBP0
	// ioRegisters[0xFF49-0xFF00] = 0x00 // OBP1
	ioRegisters[0xFF4A-0xFF00] = 0x00 // WY
	ioRegisters[0xFF4B-0xFF00] = 0x00 // WX
	interruptRegister = 0x00          // IE
	PC = 0x0100
}

func readMemory(address uint16) {

}

func writeMemory(address uint16, value uint8) {
}

func loadRom(this js.Value, args []js.Value) interface{} {
	fmt.Println("Go: loadRom()")

	jsRomData := args[0]
	cartridgeRom = make([]byte, jsRomData.Get("length").Int())
	js.CopyBytesToGo(cartridgeRom, jsRomData)

	initPostBootRomState()

	return nil
}
